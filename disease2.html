<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crop Disease Detector</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for mobile-first design and modern look */
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        #videoElement {
            transform: scaleX(-1); /* Mirror the video stream for selfie-like view */
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 1.5rem; /* Large rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #000;
        }
        #captureCanvas { display: none; } /* Canvas is only for processing */
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <header class="text-center mb-6 w-full max-w-xl">
        <h1 id="appTitle" class="text-3xl font-bold text-green-700">DICE-Crop Disease Detection-AI</h1>
        <p id="appSubtitle" class="text-gray-600">Real-time Crop Health Assistant</p>
    </header>

    <main class="w-full max-w-xl">
        <!-- Language Selector -->
        <div class="mb-4">
            <label for="language-select" class="block text-sm font-medium text-gray-700 mb-1">Select Language:</label>
            <select id="language-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500">
                <option value="en">English</option>
                <option value="hi">हिन्दी (Hindi)</option>
                <option value="pa">ਪੰਜਾਬੀ (Punjabi)</option>
                <option value="zh">中文 (Mandarin Chinese)</option>
            </select>
        </div>
        <!-- End Language Selector -->

        <!-- 1. Camera Feed Area -->
        <div class="card">
            <h2 id="captureTitle" class="text-xl font-semibold mb-3 text-green-800">1. Capture Image</h2>
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="captureCanvas"></canvas>
            <button id="captureBtn" class="w-full mt-4 py-3 bg-green-500 text-white font-bold rounded-full hover:bg-green-600 transition duration-300 shadow-md">
                Capture for Analysis
            </button>
            <div id="cameraStatus" class="mt-2 text-center text-red-500 font-medium hidden">Camera not available or access denied.</div>
        </div>

        <!-- 2. Result Area -->
        <div class="card">
            <h2 id="resultsTitle" class="text-xl font-semibold mb-3 text-green-800">2. Detection Result</h2>

            <div id="loadingIndicator" class="hidden text-center py-8">
                <div class="w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto mb-2 pulse-animation"></div>
                <p id="loadingText" class="text-gray-600">Analyzing crop... please wait.</p>
            </div>

            <div id="resultsContent" class="hidden">
                <h3 id="analysisHeader" class="text-lg font-bold text-gray-800 mb-2">Analysis:</h3>
                <p id="analysisText" class="text-gray-700 whitespace-pre-wrap"></p>
                <div id="citationContainer" class="mt-4 border-t pt-3 hidden">
                    <h4 id="sourcesHeader" class="text-sm font-semibold text-gray-600 mb-1">Sources Grounding:</h4>
                    <ul id="sourcesList" class="text-xs text-gray-500 list-disc pl-5 space-y-1"></ul>
                </div>
            </div>
        </div>

        <!-- Hidden Alert Box -->
        <div id="alertBox" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
                <h3 id="errorHeader" class="text-xl font-bold text-red-600 mb-3">Error</h3>
                <p id="alertMessage" class="text-gray-700 mb-4"></p>
                <button id="alertCloseBtn" class="w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Close</button>
            </div>
        </div>

    </main>

    <script>
        // Global variables
        const apiKey = "AIzaSyAA8fc6mvqSq0FdNDIIUqXhQs7Iap0q-SM";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Global translations object
        const translations = {
            'en': {
                appTitle: "DICE-Crop Disease Detection-AI",
                appSubtitle: "Real-time Crop Health Assistant",
                captureTitle: "1. Capture Image",
                captureBtn: "Capture for Analysis",
                cameraError: "Camera not available or access denied. Please ensure you grant permission.",
                resultsTitle: "2. Detection Result",
                analyzingText: "Analyzing crop... please wait.",
                translatingText: "Translating result...",
                analysisHeader: "Analysis:",
                sourcesHeader: "Sources Grounding:",
                errorHeader: "Error",
                alertFailedAnalysis: "AI Analysis failed after multiple retries. Please check your internet connection and try again.",
                alertCameraInactive: "Camera stream not active. Please ensure camera access is granted.",
                alertModelError: "Detection failed: Could not get a response from the AI model.",
                closeBtn: "Close",
            },
            'hi': {
                appTitle: "DICE-फसल रोग पहचान-एआई",
                appSubtitle: "वास्तविक समय फसल स्वास्थ्य सहायक",
                captureTitle: "1. छवि कैप्चर करें",
                captureBtn: "विश्लेषण के लिए कैप्चर करें",
                cameraError: "कैमरा उपलब्ध नहीं या पहुंच से मना किया गया। कृपया सुनिश्चित करें कि आपने अनुमति दी है।",
                resultsTitle: "2. पहचान परिणाम",
                analyzingText: "फसल का विश्लेषण हो रहा है... कृपया प्रतीक्षा करें।",
                translatingText: "परिणाम अनुवादित हो रहा है...",
                analysisHeader: "विश्लेषण:",
                sourcesHeader: "स्रोत आधार:",
                errorHeader: "त्रुटि",
                alertFailedAnalysis: "कई प्रयासों के बाद AI विश्लेषण विफल रहा। कृपया अपना इंटरनेट कनेक्शन जांचें और पुनः प्रयास करें।",
                alertCameraInactive: "कैमरा स्ट्रीम सक्रिय नहीं है। कृपया सुनिश्चित करें कि कैमरा पहुंच प्रदान की गई है।",
                alertModelError: "पहचान विफल: AI मॉडल से कोई प्रतिक्रिया नहीं मिल सकी।",
                closeBtn: "बंद करें",
            },
            'pa': {
                appTitle: "DICE-ਫਸਲ ਰੋਗ ਖੋਜ-AI",
                appSubtitle: "ਰੀਅਲ-ਟਾਈਮ ਫਸਲ ਸਿਹਤ ਸਹਾਇਕ",
                captureTitle: "1. ਚਿੱਤਰ ਕੈਪਚਰ ਕਰੋ",
                captureBtn: "ਵਿਸ਼ਲੇਸ਼ਣ ਲਈ ਕੈਪਚਰ ਕਰੋ",
                cameraError: "ਕੈਮਰਾ ਉਪਲਬਧ ਨਹੀਂ ਜਾਂ ਪਹੁੰਚ ਤੋਂ ਇਨਕਾਰ ਕੀਤਾ ਗਿਆ। ਕਿਰਪਾ ਕਰਕੇ ਯਕੀਨੀ ਬਣਾਓ ਕਿ ਤੁਸੀਂ ਇਜਾਜ਼ਤ ਦਿੱਤੀ ਹੈ।",
                resultsTitle: "2. ਖੋਜ ਨਤੀਜਾ",
                analyzingText: "ਫਸਲ ਦਾ ਵਿਸ਼ਲੇਸ਼ਣ ਹੋ ਰਿਹਾ ਹੈ... ਕਿਰਪਾ ਕਰਕੇ ਉਡੀਕ ਕਰੋ।",
                translatingText: "ਨਤੀਜਾ ਅਨੁਵਾਦ ਕੀਤਾ ਜਾ ਰਿਹਾ ਹੈ...",
                analysisHeader: "ਵਿਸ਼ਲੇਸ਼ਣ:",
                sourcesHeader: "ਸਰੋਤ ਗਰਾਊਂਡਿੰਗ:",
                errorHeader: "ਗਲਤੀ",
                alertFailedAnalysis: "ਕਈ ਕੋਸ਼ਿਸ਼ਾਂ ਤੋਂ ਬਾਅਦ AI ਵਿਸ਼ਲੇਸ਼ਣ ਅਸਫਲ ਰਿਹਾ। ਕਿਰਪਾ ਕਰਕੇ ਆਪਣਾ ਇੰਟਰਨੈੱਟ ਕਨੈਕਸ਼ਨ ਜਾਂਚੋ ਅਤੇ ਦੁਬਾਰਾ ਕੋਸ਼ਿਸ਼ ਕਰੋ।",
                alertCameraInactive: "ਕੈਮਰਾ ਸਟ੍ਰੀਮ ਸਰਗਰਮ ਨਹੀਂ ਹੈ। ਕਿਰਪਾ ਕਰਕੇ ਯਕੀਨੀ ਬਣਾਓ ਕਿ ਕੈਮਰਾ ਪਹੁੰਚ ਦਿੱਤੀ ਗਈ ਹੈ।",
                alertModelError: "ਖੋਜ ਅਸਫਲ: AI ਮਾਡਲ ਤੋਂ ਕੋਈ ਜਵਾਬ ਪ੍ਰਾਪਤ ਨਹੀਂ ਹੋ ਸਕਿਆ।",
                closeBtn: "ਬੰਦ ਕਰੋ",
            },
            'zh': {
                appTitle: "DICE-作物病害检测-AI",
                appSubtitle: "实时作物健康助手",
                captureTitle: "1. 捕捉图像",
                captureBtn: "进行分析",
                cameraError: "相机不可用或拒绝访问。请确保您授予了权限。",
                resultsTitle: "2. 检测结果",
                analyzingText: "正在分析作物...请稍候。",
                translatingText: "正在翻译结果...",
                analysisHeader: "分析：",
                sourcesHeader: "来源依据：",
                errorHeader: "错误",
                alertFailedAnalysis: "多次重试后 AI 分析失败。请检查您的网络连接并重试。",
                alertCameraInactive: "摄像头流不活动。请确保授予摄像头访问权限。",
                alertModelError: "检测失败：无法从 AI 模型获得响应。",
                closeBtn: "关闭",
            }
        };

        // DOM Elements
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('captureCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContent = document.getElementById('resultsContent');
        const analysisText = document.getElementById('analysisText');
        const cameraStatus = document.getElementById('cameraStatus');
        const sourcesList = document.getElementById('sourcesList');
        const citationContainer = document.getElementById('citationContainer');
        const languageSelect = document.getElementById('language-select');
        const loadingText = document.getElementById('loadingText');

        let stream = null;
        let currentLang = 'en';

        /**
         * Shows a custom modal alert box
         */
        function showAlert(messageKey) {
            const t = translations[currentLang] || translations['en'];
            const message = t[messageKey] || messageKey;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertBox').classList.remove('hidden');
            document.getElementById('alertBox').classList.add('flex');
        }

        /**
         * Updates all text elements on the page
         */
        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang] || translations['en'];

            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('appSubtitle').textContent = t.appSubtitle;
            document.getElementById('captureTitle').textContent = t.captureTitle;
            document.getElementById('captureBtn').textContent = t.captureBtn;
            document.getElementById('cameraStatus').textContent = t.cameraError;
            document.getElementById('resultsTitle').textContent = t.resultsTitle;
            document.getElementById('analysisHeader').textContent = t.analysisHeader;
            document.getElementById('sourcesHeader').textContent = t.sourcesHeader;
            document.getElementById('errorHeader').textContent = t.errorHeader;
            document.getElementById('alertCloseBtn').textContent = t.closeBtn;

            if (!cameraStatus.classList.contains('hidden')) {
                cameraStatus.textContent = t.cameraError;
            }
        }

        /**
         * Initializes camera stream
         */
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    cameraStatus.classList.add('hidden');
                    captureBtn.disabled = false;
                };
            } catch (error) {
                console.error("Error accessing camera: ", error);
                const t = translations[currentLang] || translations['en'];
                cameraStatus.textContent = t.cameraError;
                cameraStatus.classList.remove('hidden');
                captureBtn.disabled = true;
            }
        }

        /**
         * Captures frame and triggers analysis
         */
        function captureFrame() {
            if (!stream) {
                showAlert("alertCameraInactive");
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const base64Image = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            analyzeImage(base64Image);
        }

        /**
         * Translates text using Gemini
         */
        async function translateText(text, targetLang) {
            if (targetLang === 'en') return text;

            const langNames = {
                'hi': 'Hindi',
                'pa': 'Punjabi',
                'zh': 'Simplified Chinese'
            };

            const prompt = `Translate the following crop disease analysis into ${langNames[targetLang] || targetLang}. 
Keep scientific accuracy, clear language, and helpful tone. 
Return ONLY the translated text:

"""${text}"""`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Translation failed");

                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || text;
            } catch (err) {
                console.error("Translation error:", err);
                return text; // fallback
            }
        }

        /**
         * Analyzes image using Gemini + translates result
         */
        async function analyzeImage(base64Data) {
            const t = translations[currentLang] || translations['en'];

            loadingIndicator.classList.remove('hidden');
            resultsContent.classList.add('hidden');
            captureBtn.disabled = true;
            loadingText.textContent = t.analyzingText;

            const userPrompt = "Analyze this image of a crop. Focus on detecting diseases common to **wheat and rice**. Based on visual evidence, what is the probable disease (if any)? Provide a brief, single-paragraph description of the symptoms and a preliminary, simple recommendation for a small farmer. Use Google Search to ground your findings for accuracy.";

            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                    ]
                }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are an expert agricultural pathologist assistant. Keep response concise, accurate, and actionable." }]
                }
            };

            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const englishText = candidate.content.parts[0].text.trim();

                        // Show translation loading
                        loadingText.textContent = t.translatingText;

                        // Translate
                        const translatedText = await translateText(englishText, currentLang);

                        // Display
                        analysisText.textContent = translatedText;

                        // Handle sources (in English)
                        sourcesList.innerHTML = '';
                        citationContainer.classList.add('hidden');
                        const grounding = candidate.groundingMetadata?.groundingAttributions;

                        if (grounding) {
                            const sources = grounding
                                .map(a => ({ uri: a.web?.uri, title: a.web?.title }))
                                .filter(s => s.uri && s.title);

                            if (sources.length > 0) {
                                sources.forEach(s => {
                                    const li = document.createElement('li');
                                    const a = document.createElement('a');
                                    a.href = s.uri; a.target = "_blank"; a.textContent = s.title;
                                    a.className = "text-blue-500 hover:text-blue-700 hover:underline";
                                    li.appendChild(a);
                                    sourcesList.appendChild(li);
                                });
                                citationContainer.classList.remove('hidden');
                            }
                        }

                        loadingIndicator.classList.add('hidden');
                        resultsContent.classList.remove('hidden');
                        captureBtn.disabled = false;
                        return;
                    } else {
                        analysisText.textContent = t.alertModelError;
                    }

                    break;

                } catch (error) {
                    console.error(`Attempt ${currentRetry + 1} failed:`, error);
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        await new Promise(r => setTimeout(r, Math.pow(2, currentRetry) * 1000));
                    } else {
                        analysisText.textContent = t.alertFailedAnalysis;
                        showAlert("alertFailedAnalysis");
                    }
                }
            }

            loadingIndicator.classList.add('hidden');
            resultsContent.classList.remove('hidden');
            captureBtn.disabled = false;
        }

        // --- Event Listeners ---
        captureBtn.addEventListener('click', captureFrame);
        languageSelect.addEventListener('change', (e) => setLanguage(e.target.value));

        // --- Init ---
        window.onload = () => {
            setLanguage(languageSelect.value);
            setupCamera();
        };
    </script>
</body>
</html>